<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Viewers en Vivo - Kick</title>
  <style>
    body {
      background-color: #0e0e0e;
      color: #fff;
      font-family: sans-serif;
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 16px;
      padding: 16px;
      margin: 0;
    }

    .widget-container {
      background-color: #1a1a1a;
      border-radius: 8px;
      padding: 8px;
      text-align: center;
      width: 360px;
      box-sizing: border-box;
      position: relative;
      min-height: 120px;
    }

    .channel-name {
      font-size: 16px;
      font-weight: bold;
      margin-bottom: 6px;
      color: #00ff88;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .timer-btn {
      background: #00ff88;
      color: #000;
      border: none;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      font-size: 18px;
      font-weight: bold;
      cursor: pointer;
      margin-left: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.2s;
    }
    .timer-btn:hover {
      background: #00cc6a;
    }
    .timer {
      margin-left: 8px;
      font-size: 14px;
      color: #fff;
      background: #222;
      border-radius: 4px;
      padding: 2px 8px;
      font-variant-numeric: tabular-nums;
      display: inline-flex;
      align-items: center;
    }
    .timer-cancel {
      background: #ff4444;
      color: #fff;
      border: none;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      font-size: 14px;
      font-weight: bold;
      cursor: pointer;
      margin-left: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.2s;
    }
    .timer-cancel:hover {
      background: #c00;
    }

    .loading-placeholder {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100px;
      color: #666;
      font-style: italic;
    }

    .iframe-wrapper {
      position: relative;
      width: 100%;
      height: 100px;
      overflow: hidden;
    }

    iframe {
      border: none;
      width: 100%;
      height: 100%;
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    iframe.loaded {
      opacity: 1;
    }

    .controls {
      position: fixed;
      top: 10px;
      right: 10px;
      background: rgba(26, 26, 26, 0.9);
      padding: 10px;
      border-radius: 8px;
      z-index: 1000;
    }

    .controls button {
      background: #00ff88;
      color: #000;
      border: none;
      padding: 5px 10px;
      border-radius: 4px;
      cursor: pointer;
      margin: 2px;
      font-size: 12px;
    }

    .controls button:hover {
      background: #00cc6a;
    }

    .controls button:disabled {
      background: #666;
      cursor: not-allowed;
    }

    h2 {
      width: 100%;
      text-align: center;
      color: #00ff88;
      font-size: 22px;
      margin-bottom: 12px;
    }

    .status {
      font-size: 12px;
      color: #888;
      margin-top: 5px;
    }
  </style>
</head>
<body>
  <div class="controls">
    <button id="toggleAll">Pausar Todo</button>
    <button id="refreshAll">Actualizar Todo</button>
    <div class="status" id="status">Cargando...</div>
  </div>

  <h2>👀 Viewers en vivo</h2>

  <div id="widgets-list">
  <div class="widget-container" data-channel="deftsulol">
    <div class="channel-name">Deftsulol</div>
    <div class="iframe-wrapper">
      <div class="loading-placeholder">Cargando...</div>
      <iframe data-src="https://kicktools.app/kick_views/kick_views.html?kick=deftsulol&theme=mini"></iframe>
    </div>
  </div>



  <div class="widget-container" data-channel="elflaco">
    <div class="channel-name">Elflaco</div>
    <div class="iframe-wrapper">
      <div class="loading-placeholder">Cargando...</div>
      <iframe data-src="https://kicktools.app/kick_views/kick_views.html?kick=elflaco&theme=mini"></iframe>
    </div>
  </div>

  <div class="widget-container" data-channel="role7">
    <div class="channel-name">Role7</div>
    <div class="iframe-wrapper">
      <div class="loading-placeholder">Cargando...</div>
      <iframe data-src="https://kicktools.app/kick_views/kick_views.html?kick=role7&theme=mini"></iframe>
    </div>
  </div>

  <div class="widget-container" data-channel="desacatoo">
    <div class="channel-name">Desacatoo</div>
    <div class="iframe-wrapper">
      <div class="loading-placeholder">Cargando...</div>
      <iframe data-src="https://kicktools.app/kick_views/kick_views.html?kick=desacatoo&theme=mini"></iframe>
    </div>
  </div>

  <div class="widget-container" data-channel="mandreva">
    <div class="channel-name">Mandreva</div>
    <div class="iframe-wrapper">
      <div class="loading-placeholder">Cargando...</div>
      <iframe data-src="https://kicktools.app/kick_views/kick_views.html?kick=mandreva&theme=mini"></iframe>
    </div>
  </div>

  <div class="widget-container" data-channel="hinchapelota">
    <div class="channel-name">Hinchapelota</div>
    <div class="iframe-wrapper">
      <div class="loading-placeholder">Cargando...</div>
      <iframe data-src="https://kicktools.app/kick_views/kick_views.html?kick=hinchapelota&theme=mini"></iframe>
    </div>
  </div>

  <div class="widget-container" data-channel="x1nofps">
    <div class="channel-name">X1nofps</div>
    <div class="iframe-wrapper">
      <div class="loading-placeholder">Cargando...</div>
      <iframe data-src="https://kicktools.app/kick_views/kick_views.html?kick=x1nofps&theme=mini"></iframe>
    </div>
  </div>

  <div class="widget-container" data-channel="feitansupp">
    <div class="channel-name">Feitansupp</div>
    <div class="iframe-wrapper">
      <div class="loading-placeholder">Cargando...</div>
      <iframe data-src="https://kicktools.app/kick_views/kick_views.html?kick=feitansupp&theme=mini"></iframe>
    </div>
  </div>

  <div class="widget-container" data-channel="bastardigangg">
    <div class="channel-name">Bastardigangg</div>
    <div class="iframe-wrapper">
      <div class="loading-placeholder">Cargando...</div>
      <iframe data-src="https://kicktools.app/kick_views/kick_views.html?kick=BASTARDIGANGG&theme=mini"></iframe>
    </div>
  </div>
  </div>

  <script>
    class WidgetManager {
      constructor() {
        this.widgets = [];
        this.isPaused = false;
        this.loadingDelay = 2000; // 2 segundos entre cargas
        this.refreshInterval = 30000; // 30 segundos entre actualizaciones
        this.currentIndex = 0;
        this.onlineChannels = [];
        this.offlineChannels = [];
        this.allOfflineNotified = false;
        this.anyOnlineNotified = false;
        this.init();
      }

      init() {
        this.collectWidgets();
        this.setupControls();
        this.setupTimers();
        this.startLazyLoading();
        this.updateStatus();
      }

      collectWidgets() {
        const containers = document.querySelectorAll('.widget-container');
        containers.forEach((container, index) => {
          const iframe = container.querySelector('iframe');
          const placeholder = container.querySelector('.loading-placeholder');
          const channelName = container.querySelector('.channel-name').textContent;
          const channelId = container.dataset.channel.toLowerCase();

          // Crear campo de ID editable
          const idInput = document.createElement('input');
          idInput.type = 'text';
          idInput.placeholder = 'ID';
          idInput.className = 'order-id-input';
          idInput.style.marginLeft = '8px';
          idInput.style.width = '70px';
          idInput.style.fontSize = '13px';
          idInput.style.borderRadius = '4px';
          idInput.style.border = '1px solid #444';
          idInput.style.background = '#222';
          idInput.style.color = '#fff';
          idInput.style.padding = '2px 6px';

          // Crear botón Restart
          const restartBtn = document.createElement('button');
          restartBtn.textContent = 'Restart';
          restartBtn.className = 'restart-btn';
          restartBtn.style.marginLeft = '6px';
          restartBtn.style.background = '#00ff88';
          restartBtn.style.color = '#000';
          restartBtn.style.border = 'none';
          restartBtn.style.borderRadius = '4px';
          restartBtn.style.padding = '2px 8px';
          restartBtn.style.cursor = 'pointer';
          restartBtn.style.fontSize = '13px';
          restartBtn.style.fontWeight = 'bold';
          restartBtn.style.transition = 'background 0.2s';
          restartBtn.addEventListener('mouseenter', () => restartBtn.style.background = '#00cc6a');
          restartBtn.addEventListener('mouseleave', () => restartBtn.style.background = '#00ff88');

          // Notificación visual
          const copyNotif = document.createElement('span');
          copyNotif.textContent = '¡Mensaje copiado al portapapeles!';
          copyNotif.style.display = 'none';
          copyNotif.style.marginLeft = '8px';
          copyNotif.style.color = '#00ff88';
          copyNotif.style.fontSize = '12px';
          copyNotif.style.fontWeight = 'bold';

          restartBtn.addEventListener('click', () => {
            const idValue = idInput.value.trim();
            if (!idValue) {
              idInput.focus();
              idInput.style.border = '1.5px solid #ff4444';
              setTimeout(() => idInput.style.border = '1px solid #444', 1200);
              return;
            }
            const msg = `Hi, restart this order please ID ${idValue}`;
            // Copiar al portapapeles
            navigator.clipboard.writeText(msg).then(() => {
              copyNotif.style.display = '';
              setTimeout(() => copyNotif.style.display = 'none', 1800);
            });
          });

          // Insertar el input, botón y notificación en el nombre del canal
          const channelNameEl = container.querySelector('.channel-name');
          channelNameEl.appendChild(idInput);
          channelNameEl.appendChild(restartBtn);
          channelNameEl.appendChild(copyNotif);

          // Crear botón + y span para el timer
          const timerBtn = document.createElement('button');
          timerBtn.className = 'timer-btn';
          timerBtn.textContent = '+';
          const timerSpan = document.createElement('span');
          timerSpan.className = 'timer';
          timerSpan.style.display = 'none';
          const timerText = document.createElement('span');
          timerText.className = 'timer-text';
          timerSpan.appendChild(timerText);
          const cancelBtn = document.createElement('button');
          cancelBtn.className = 'timer-cancel';
          cancelBtn.textContent = '✖';
          cancelBtn.style.display = 'none';
          timerSpan.appendChild(cancelBtn);

          // Insertar el botón y el timer en el nombre del canal
          channelNameEl.appendChild(timerBtn);
          channelNameEl.appendChild(timerSpan);

          this.widgets.push({
            container,
            iframe,
            placeholder,
            channelName, // nombre visual
            channelId,   // nombre para API
            timerBtn,
            timerSpan,
            timerText,
            cancelBtn,
            timer: null,
            timerInterval: null,
            timerNotified: false,
            isLoaded: false,
            lastRefresh: 0,
            isOnline: false,
            lastStatusCheck: 0
          });
        });
      }

      setupControls() {
        const toggleBtn = document.getElementById('toggleAll');
        const refreshBtn = document.getElementById('refreshAll');

        toggleBtn.addEventListener('click', () => {
          this.isPaused = !this.isPaused;
          toggleBtn.textContent = this.isPaused ? 'Reanudar Todo' : 'Pausar Todo';
          this.updateStatus();
        });

        refreshBtn.addEventListener('click', () => {
          this.refreshAllWidgets();
        });

        // Pausar cuando la pestaña no está visible
        document.addEventListener('visibilitychange', () => {
          if (document.hidden) {
            this.isPaused = true;
            toggleBtn.textContent = 'Reanudar Todo';
          }
        });
      }

      setupTimers() {
        this.widgets.forEach(widget => {
          widget.timerBtn.addEventListener('click', () => {
            let input = prompt('¿Cuánto tiempo? (hh:mm:ss)', '01:00:00');
            if (!input) return;
            // Validar formato hh:mm:ss
            const match = input.match(/^(\d{1,2}):(\d{2}):(\d{2})$/);
            if (!match) return alert('Formato inválido. Usa hh:mm:ss');
            const h = parseInt(match[1], 10);
            const m = parseInt(match[2], 10);
            const s = parseInt(match[3], 10);
            const totalSeconds = h * 3600 + m * 60 + s;
            if (isNaN(totalSeconds) || totalSeconds <= 0) return alert('Tiempo inválido');
            this.startTimer(widget, totalSeconds);
          });
          widget.cancelBtn.addEventListener('click', () => {
            this.cancelTimer(widget);
          });
        });
      }

      startTimer(widget, seconds) {
        if (widget.timerInterval) clearInterval(widget.timerInterval);
        widget.timer = seconds;
        widget.timerNotified = false;
        widget.timerSpan.style.display = '';
        this.updateTimerDisplay(widget);
        widget.timerInterval = setInterval(() => {
          if (widget.timer > 0) {
            widget.timer--;
            this.updateTimerDisplay(widget);
            if (widget.timer === 900 && !widget.timerNotified) { // 15 minutos
              this.notify15(widget.channelName);
              widget.timerNotified = true;
            }
          } else {
            clearInterval(widget.timerInterval);
            this.cancelTimer(widget);
          }
        }, 1000);
      }

      updateTimerDisplay(widget) {
        if (widget.timer == null) {
          widget.timerSpan.style.display = 'none';
          widget.cancelBtn.style.display = 'none';
          return;
        }
        const m = Math.floor(widget.timer / 60);
        const s = widget.timer % 60;
        const h = Math.floor(m / 60);
        const mm = m % 60;
        widget.timerText.textContent = `${h.toString().padStart(2, '0')}:${mm.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
        widget.cancelBtn.style.display = '';
      }

      notify15(channelName) {
        if (Notification.permission === 'granted') {
          new Notification(`¡Quedan 15 minutos para que termine el stream de ${channelName}!`);
        } else if (Notification.permission !== 'denied') {
          Notification.requestPermission().then(permission => {
            if (permission === 'granted') {
              new Notification(`¡Quedan 15 minutos para que termine el stream de ${channelName}!`);
            }
          });
        }
      }

      cancelTimer(widget) {
        if (widget.timerInterval) clearInterval(widget.timerInterval);
        widget.timer = null;
        widget.timerSpan.style.display = 'none';
        widget.cancelBtn.style.display = 'none';
      }

      startLazyLoading() {
        // Cargar todos los widgets a la vez
        for (let i = 0; i < this.widgets.length; i++) {
          this.loadWidget(i);
        }
      }

      loadWidget(index) {
        if (index >= this.widgets.length) return;
        
        const widget = this.widgets[index];
        if (widget.isLoaded) return;

        const iframe = widget.iframe;
        const placeholder = widget.placeholder;

        iframe.src = iframe.dataset.src;
        
        iframe.addEventListener('load', () => {
          iframe.classList.add('loaded');
          placeholder.style.display = 'none';
          widget.isLoaded = true;
          widget.lastRefresh = Date.now();
          
          // Comenzar a detectar el estado después de cargar
          setTimeout(() => this.detectChannelStatus(index), 3000);
          
          this.updateStatus();
        });

        iframe.addEventListener('error', () => {
          placeholder.textContent = 'Error al cargar';
          placeholder.style.color = '#ff4444';
        });
      }

      async detectChannelStatus(index) {
        const widget = this.widgets[index];
        if (!widget.isLoaded || this.isPaused) return;

        const now = Date.now();
        if (now - widget.lastStatusCheck < 15000) return; // Verificar cada 15 segundos

        try {
          const isOnline = await this.checkChannelOnline(widget.channelId);

          // Log de depuración
          console.log(`Canal: ${widget.channelId} | Estado API: ${isOnline ? 'EN VIVO' : 'OFFLINE'}`);

          widget.isOnline = isOnline;
          widget.lastStatusCheck = now;

          // Actualizar indicador visual
          this.updateChannelIndicator(widget, isOnline);
          
          // Reordenar canales después de detectar el estado
          this.reorderChannels();

        } catch (error) {
          console.log(`Error checking status for ${widget.channelName}:`, error);
        }
      }

      async checkChannelOnline(channelId) {
        try {
          const response = await fetch(`https://kick.com/api/v1/channels/${channelId}`, {
            method: 'GET',
            headers: {
              'Accept': 'application/json',
              'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'
            }
          });
          
          if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
          }
          
          const data = await response.json();
          return data.livestream && data.livestream.is_live;
        } catch (error) {
          console.log(`Error checking channel ${channelId}:`, error);
          return false;
        }
      }

      refreshWidget(index) {
        const widget = this.widgets[index];
        if (!widget.isLoaded) return;
        
        const iframe = widget.iframe;
        const currentSrc = iframe.src;
        
        // Refrescar el iframe
        iframe.src = '';
        setTimeout(() => {
          iframe.src = currentSrc;
        }, 100);
      }

      updateStatus() {
        const statusEl = document.getElementById('status');
        const onlineCount = this.widgets.filter(w => w.isOnline).length;
        const totalCount = this.widgets.length;
        
        statusEl.textContent = `${onlineCount}/${totalCount} canales en vivo`;
      }

      notifyAllOffline() {
        const msg = 'Todos los canales están offline.';
        if (Notification.permission === 'granted') {
          new Notification(msg);
        } else if (Notification.permission !== 'denied') {
          Notification.requestPermission().then(permission => {
            if (permission === 'granted') {
              new Notification(msg);
            }
          });
        }
      }

      notifyAnyOnline(names) {
        const msg = `¡Hay canales en vivo! ${names}`;
        if (Notification.permission === 'granted') {
          new Notification(msg);
        } else if (Notification.permission !== 'denied') {
          Notification.requestPermission().then(permission => {
            if (permission === 'granted') {
              new Notification(msg);
            }
          });
        }
      }

      updateChannelIndicator(widget, isOnline) {
        const channelNameEl = widget.container.querySelector('.channel-name');
        
        if (isOnline) {
          channelNameEl.innerHTML = `${widget.channelName} <span style='color: #00ff88; font-size: 12px;'>● EN VIVO</span>`;
          widget.container.style.border = '2px solid #00ff88';
        } else {
          channelNameEl.innerHTML = `${widget.channelName} <span style='color: #666; font-size: 12px;'>○ OFFLINE</span>`;
          widget.container.style.border = '2px solid #333';
        }
      }

      reorderChannels() {
        const widgetsList = document.getElementById('widgets-list');
        // Separar canales online y offline
        const onlineWidgets = this.widgets.filter(w => w.isOnline);
        const offlineWidgets = this.widgets.filter(w => !w.isOnline);

        // Detectar canales que acaban de pasar de offline a online
        if (!this._prevOnlineStates) this._prevOnlineStates = {};
        const justWentOnline = [];
        this.widgets.forEach(w => {
          if (w.isOnline && !this._prevOnlineStates[w.channelId]) {
            justWentOnline.push(w);
          }
          this._prevOnlineStates[w.channelId] = w.isOnline;
        });
        // Notificar solo por los que acaban de comenzar
        justWentOnline.forEach(w => this.notifyStreamStarted(w.channelName));

        // Eliminar todos los hijos del contenedor (más robusto)
        while (widgetsList.firstChild) {
          widgetsList.removeChild(widgetsList.firstChild);
        }

        // Agregar online primero
        onlineWidgets.forEach(widget => {
          widgetsList.appendChild(widget.container);
        });
        // Luego offline
        offlineWidgets.forEach(widget => {
          widgetsList.appendChild(widget.container);
        });

        // Forzar refresco visual (hack)
        widgetsList.style.display = 'none';
        void widgetsList.offsetHeight;
        widgetsList.style.display = '';

        // Actualizar arrays
        this.onlineChannels = onlineWidgets;
        this.offlineChannels = offlineWidgets;

        this.updateStatus();

        // Notificación: todos offline
        if (onlineWidgets.length === 0 && offlineWidgets.length > 0 && !this.allOfflineNotified) {
          this.notifyAllOffline();
          this.allOfflineNotified = true;
        }
        // Resetear bandera si vuelve a haber alguno online
        if (onlineWidgets.length > 0) {
          this.allOfflineNotified = false;
          if (!this.anyOnlineNotified) {
            const names = onlineWidgets.map(w => w.channelName).join(', ');
            this.notifyAnyOnline(names);
            this.anyOnlineNotified = true;
          }
        } else {
          this.anyOnlineNotified = false;
        }
      }

      startRefreshCycle() {
        setInterval(async () => {
          if (!this.isPaused && !document.hidden) {
            // Refrescar y detectar estado de todos los widgets
            const detectPromises = this.widgets.map((widget, index) => {
              this.refreshWidget(index);
              return this.detectChannelStatus(index);
            });
            // Esperar a que todos los estados se hayan verificado antes de reordenar
            await Promise.all(detectPromises);
            this.reorderChannels();
          }
        }, this.refreshInterval);
      }

      notifyStreamStarted(name) {
        const msg = `¡Atención! ${name} acaba de comenzar el stream.`;
        if (Notification.permission === 'granted') {
          new Notification(msg);
        } else if (Notification.permission !== 'denied') {
          Notification.requestPermission().then(permission => {
            if (permission === 'granted') {
              new Notification(msg);
            }
          });
        }
      }
    }

    // Inicializar cuando el DOM esté listo
    document.addEventListener('DOMContentLoaded', () => {
      const manager = new WidgetManager();
      manager.startRefreshCycle();
    });

    // Optimización adicional: reducir uso de CPU cuando la pestaña no está activa
    let hiddenTime = 0;
    document.addEventListener('visibilitychange', () => {
      if (document.hidden) {
        hiddenTime = Date.now();
      } else {
        // Si estuvo oculta por más de 5 minutos, recargar todo
        if (Date.now() - hiddenTime > 300000) {
          location.reload();
        }
      }
    });
  </script>
</body>
</html>